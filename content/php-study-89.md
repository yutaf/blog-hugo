+++
date = "2015-04-30T18:14:33+09:00"
draft = false
title = "第89回 PHP勉強会＠東京"
tags = ["php", "ryogoku", "meetup", "presentation"]

+++

先日、[デプロイツールを作成したという記事](/i-made-a-deployment-tool-ryogoku/)を投稿したが、[第89回 PHP勉強会＠東京](https://phpstudy.doorkeeper.jp/events/23826) でそれについての発表を行った。  
<!--more-->

当日の朝に自分が発表者になっていることに気づき、大急ぎで資料を準備して発表に臨んだ。  
発表の段取りや分量など、かなり失敗して恥ずかしかったが、気付きもあったのでチャレンジしてよかった。  
ちなみに、これは自分にとって初めての社外の人に向けた発表だった。  

<iframe src="//www.slideshare.net/slideshow/embed_code/key/tIIytx7ajztnz5" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>

## 発表を通じてわかったこと

**発表の時間配分**

本題に入る前に時間が終わるというひどい体たらくだった。  
今後、リハーサルはしっかりやろう、自分。  

**参加者のデプロイツール使用状況**

参加者の方のデプロイ状況を知りたかったので、発表中に聞いてみた。  

- デプロイツールを使っている人数  
20-30 / 60 人  
- 内訳  
  - capistrano 95 %
  - fabric 1人?
  - rocketeer 1人?

なんだかんだ capistrano 人気の根強さに驚いた。

**質問**

発表に対する質問も受けた。そのおかげで、デプロイに関してのポイントや自分が気づいていないところに気づけたので、質問者の方には感謝したい。  
質問は本当に大事ですね。  

- **「既存のツールを使わないで、自分たちで作ったツールを使うメリットは？」**<br />  
その時は上手く答えられなかったので、ここに書こうと思う。<br />  
メリットは、自分たちの仕事に最適化したツールが作れるということ。  
既存のツールの不要な機能をそぎ落として、自分たちに必要な最低限のものを作れる。<br />  
デメリットは、しっかりメンテナンスをしなければならないこと。  
スライド中にある、フロントツールのビルドに時間がかかるといった問題のように、時間の経過とともに出てくる問題に対処出来なければ使い続けていけるツールにならない。<br />  
また、既存のツールと違い、ネット上に情報が集積されていないので、作成者以外の人間が理解できるようドキュメントの整備は既存のツール以上にしっかりやらなければならない。<br />  
この辺りのことを考えると本当に一長一短で、 今後上手く行かなくなった時の選択肢として、 capistrano やその他の方法も考慮しておかなければと思っている。<br />  
- **「APC, OPcache を使用しているアプリケーションのデプロイは上手くいくか」**<br />  
恥ずかしながら、APC, OPcache について知らなかった。  
<https://www.xserver.ne.jp/manual/man_server_php_apc.php>  
`「APC」や「OPcache」とは、PHPの高速化、CPU負荷を軽減するための拡張モジュールです。`  
`これらの拡張機能においては、PHPの初回実行時に、PHPの内容を最適化した状態でキャッシュしておき、次回以降、同じPHPにアクセスがあった際にキャッシュを利用することで、PHP実行時のCPU負荷の軽減や、PHPの大幅な高速化を図ることが可能です。`<br />  
おそらくこの質問者の方が聞きたかったことに関連する記事もあった。  
<http://kohkimakimoto.hatenablog.com/entry/2014/09/13/154342>  
`OPcacheはシンボリックを解決して、実ファイルパスの状態でキャッシュする。`  
`よってシンボリックリンクを更新しても、実ファイルパスのキャッシュが保持されてしまう。`<br />  
つまり、capistrano のようなシンボリックリンクを切り替えることでデプロイを実現しているツールでは、OPcache のキャッシュの影響で最新のファイルが実行・表示されないという問題があるらしい。  
もちろん、上記ブログではその解決策も記されている。  
こういった問題があることは全く知らなかったので勉強になりました。<br />  
ryogoku に関して言えば、シンボリックリンクを張り替えず、実ファイルを上書きする作りになっているので、OPcache を使っていても問題にならない。<br />  
一方で考えたことは、OPcache を使うような高いパフォーマンスが求められるアプリケーションでは、シンボリックリンクを切り替えるタイプのゼロダウンタイムなデプロイが求められるのではないかということ。  
そういったアプリケーションには ryogoku は不向きだと思った。<br />  
ryogoku が向いているのは、ゲームなどのリアルタイム性が強く求められるものでなく、静的なコンテンツやブログ、CMSなど、コンマ何秒間のダウンタイムが問題にならないものかと思う。  
言い換えれば、自分たちが普段仕事で開発しているアプリケーションがそういったもので、その範囲であれば ryogoku は十分なツールだと思っている。  

- **「ロールバックはどうしている？」**<br />  
ryogoku には revert というコマンドがあり、それでロールバックを実現している。  
このコマンドの実際の動作がどうなっているかというと、戻りたいgit の commit id を指定してデプロイしている。  
つまり、バックアップからの復元でない。  
大抵はこれで上手くロールバックできるが、正直、上手くいかなかったこともある。<br />  
細かい話になるので簡単に言いたいが、あるデプロイを境に rsync の除外リストから外されたファイル(転送対象になったファイル)があると、ロールバックしたときに不要なファイルがデプロイ先サーバーに残ってしまうことがある。  
これは今後改善しなくてはと思っている。<br />  
ちなみに capistrano であれば、デプロイごとにアプリケーションをまるまるディレクトリごと作成して、シンボリックリンクを張り替えて対応しているので、ロールバックも過去のディレクトリにリンクを張り替えればいいだけなので、確実。<br />  
ただ、ryogoku をシンボリックリンクを張り替えるつくりにはしたくないので、なにか考えないといけない。

## 発表を通じてわかったこと・まとめ

- 勉強会は補欠になっていても、繰り上がって発表者になることがあるので、準備はしておく
- 自作ツールは自分たちの仕事に合わせた細かい調整が利くが、メンテナンスやドキュメント整備を続ける責任がある
- ryogoku は静的なコンテンツやブログ、CMS といったコンマ何秒程度のダウンタイムを気にしなくていいアプリケーションのデプロイに向いている
- ryogoku のロールバックには改善の余地あり
